<!DOCTYPE html>
<html>
  <head>
    <meta name="google-site-verification" content="LuC5G9RgHqMbCs-j6JqTMh9NjBFDlnmtliW1JOyotbQ" />
    <meta charset="utf-8">
    <meta name=keywords content="takuti,たくち" />
    <meta name=description content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
        HTML5 Canvasの回転と角丸についてメモ | takuti.me
      
    </title>

    <link rel="stylesheet" href="https://takuti.me/style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
    <link rel="shortcut icon" href="https://takuti.me/images/favicon.ico" />
    <link rel="alternate" type="application/atom+xml" title="takuti.me" href="https://takuti.me/index.xml" />
  </head>
  <body>
    <header class="clearfix">
      <span class="left"><a href="https://takuti.me/"><b>takuti</b>.me</a></span>
      <span class="right"><a href="https://takuti.me/about"><b>ABOUT</b></a></span>
    </header>

    <div id="container">

<article>
  <p class="meta clearfix">
    2013-08-03
  </p>
  <h2>HTML5 Canvasの回転と角丸についてメモ</h2>

  <div class="post">
    <p><a href="http://blog.takuti.me/meltokei/">HTML5 CanvasでメルトPVに出てくるメル時計をつくった</a>で、ビギナーの僕には少し厄介だった回転と角丸化についてメモメモ。<br />
<!--more--></p>
<h3>回転 rotate() の扱い方</h3>
<p><a href="http://takuti.me/dev/meltokei/">メル時計</a>の文字盤代わりの六角形は、12時の位置に全ての時刻分を（色を変えながら）作りつつ、それらを30°ずつ回転させていくことで描画しました。</p>
<p><img src="https://takuti.me/images/wp/hexagon.png" alt="hexagon" width="202" height="144" class="alignnone size-full wp-image-237" /><br />
1：てっぺんをスタートして右に8px、下に10pxの移動<br />
2：下に18pxの移動<br />
3：2の移動した先から、更に下に3px移動したところが、もう1つの六角形のてっぺん</p>
<p>この3つさえ分かればあとは対称だったりするので、とりあえず12時の位置に色を変えながら量産することは問題なくできます。あとは30°ずつ回転をさせるだけです。</p>
<p>しかし、<strong>rotate()</strong>はcanvasそのものの左上を中心とみて回転させるので、ふつうに<strong>rotate(Math.PI/6)</strong>とかやっても思うように回ってくれません。円（時計）の中心を回転の中心にしてほしい！</p>
<p>そんなときは、「現時点でのcanvasそのものの左上を円の中心にズラしてから回転させる。回転が終わったらズラした分を元に戻す。」という方法をとるみたいです。</p>
<p>【参考】<a href="http://tech.kayac.com/archive/canvas-tutorial.html">今更聞けないcanvasの基礎の基礎 | tech.kayac.com - KAYAC engineers' blog</a></p>
<p>つまり、canvas全体を回転の中心にしたい座標（今回は400x400のcanvasに描画した半径200の円の中心なので(200,200)）の分だけ移動して、本来回転させたかった角度で回転させたら、移動させた分を元に戻す、と。</p>
<pre class="prettyprint lang-js">
ctx.translate(200,200);
ctx.rotate(30*Math.PI/180);
ctx.translate(-200,-200);
</pre>
<p>デキター！</p>
<p>ちなみに、<strong>rotate()</strong>の状態を解除する方法も分からなくて悲しみました。</p>
<p><strong>rotate(θ)</strong>をした後に何もしないと、以後の描画処理が全て角度θだけ回転した状態で行われてしまうんですね。だから、もう回転の必要がなくなったらそれを解除して、全く回転していない状態に戻してあげる必要があるというわけなんだとか。</p>
<p>そこでよく使われるのが<strong>save()</strong>と<strong>restore()</strong>で、これらを使うと描画状態（回転情報も含んでいる<strong>変換行列</strong>など）を保存して、復元することができる。</p>
<p>全く回転していない状態を<strong>save()</strong>して、回転の必要がなくなったところですぐ<strong>restore()</strong>してあげれば、その後もイメージどおりに描画できるんですね！</p>
<pre class="prettyprint lang-js">
ctx.save(); // 変換行列の初期状態（全く回転していない状態）を保存

rotateSomething(); // 回転を含む処理

// 回転を含む処理の後には必ず変換行列を初期状態に戻し、再度保存しておく
ctx.restore();
ctx.save();
</pre>
<p><strong>save()</strong>と<strong>restore()</strong>はスタックのPushとPopに対応するので、一度<strong>restore()</strong>をしてしまうとせっかく保存していた初期状態の情報が消えてしまいます。そのため、<strong>restore()</strong>の直後にもう一度<strong>save()</strong>をして、次の回転を含む処理に備えます。</p>
<p>というわけで、移動させてから回転させてまた戻すことと、回転した状態を解除することによって、イメージ通りの回転を含む描画処理いろいろができました。</p>
<h3>角丸な長方形</h3>
<p>長方形を角丸にしたい場面はたくさんあるのに、Canvasではササッと角丸な長方形を作ってくれる機能などありません。</p>
<p>そこで、角丸長方形は1/4の円弧を4つ描いてそれらを結ぶことによって実現します。</p>
<p><img src="https://takuti.me/images/wp/Screen-Shot-2013-08-04-at-12.19.25-PM.png" alt="Screen Shot 2013-08-04 at 12.19.25 PM" width="130" height="130" class="alignnone size-full wp-image-239" /><br />
これは円弧ひとつひとつに対して<strong>beginPath()</strong>,<strong>stroke()</strong>をしたもの。</p>
<p>これを、<strong>beginPath()</strong>を最初に一度だけ行い、円弧すべての<strong>arc()</strong>を実行した後に<strong>closePath()</strong>をしてあげるようにすれば、あとは<strong>stroke()</strong>なり<strong>fill()</strong>なりでお好みの角丸な長方形ができあがる。</p>
<p>長方形の位置や幅、高さは4つの円弧の中心点に依存するわけですね。</p>
<p>これについては、以下を参考にさせていただき解釈しました。<br />
<a href="http://devlabo.blogspot.jp/2010/03/javascriptcanvas.html">[javascript]canvasで円や角丸の矩形を描画する</a></p>
<p>以上、回転と角丸についてのメモでした。</p>

    <br /><a href="https://twitter.com/share" class="twitter-share-button" data-via="takuti">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </div>

</article>
<aside class="clearfix">
  <span class="left" style="width: 10%">
    <img src="https://takuti.me/images/takuti.jpg" alt="takuti" class="icon-circle" />
  </span>
  <span class="right" style="width: 90%">
    I am <b>Takuya Kitazawa</b> (a.k.a. <b>takuti</b>), a data science engineer at <b><a href="https://www.treasuredata.com/" class="post-style" target="_blank" rel="noopener">Treasure Data, Inc.</a></b> and <b><a href="https://hivemall.incubator.apache.org/" class="post-style" target="_blank" rel="noopener">Apache Hivemall</a></b> Committer<span class="symbol">twinkle</span><a href="https://takuti.me/about">&raquo; more</a>
  </span>
</aside>

    </div>

    <footer>
      &copy; 2012-2016 Takuya Kitazawa.
    </footer>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
    <script>
      renderMathInElement(document.body,
        {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
            ]
        }
      );

      var inlineMathArray = document.querySelectorAll("script[type='math/tex']");
      for (var i = 0; i < inlineMathArray.length; i++) {
        var inlineMath = inlineMathArray[i];
        var tex = inlineMath.innerText || inlineMath.textContent;
        var replaced = document.createElement("span");
        replaced.innerHTML = katex.renderToString(tex, {displayMode: false});
        inlineMath.parentNode.replaceChild(replaced, inlineMath);
      }

      var displayMathArray = document.querySelectorAll("script[type='math/tex; mode=display']");
      for (var i = 0; i < displayMathArray.length; i++) {
        var displayMath = displayMathArray[i];
        var tex = displayMath.innerHTML;
        var replaced = document.createElement("span");
        replaced.innerHTML = katex.renderToString(tex.replace(/%.*/g, ''), {displayMode: true});
        displayMath.parentNode.replaceChild(replaced, displayMath);
      }
    </script>
    

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-28919399-2', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

