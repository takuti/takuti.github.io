<!DOCTYPE html>
<html>
  <head>
    <meta name="google-site-verification" content="LuC5G9RgHqMbCs-j6JqTMh9NjBFDlnmtliW1JOyotbQ" />
    <meta charset="utf-8">
    <meta name=keywords content="takuti,ãŸãã¡" />
    <meta name=description content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
        ã‚ã®ã¨ãã®ãƒ“ãƒ¼ãƒ«ã‚’ã‚‚ã†ä¸€åº¦ï¼ˆPostgreSQLã§Fuzzy Searchã‚’è©¦ã™ï¼‰ | takuti.me
      
    </title>

    <link rel="stylesheet" href="https://takuti.me/style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
    <link rel="shortcut icon" href="https://takuti.me/images/favicon.ico" />
    <link rel="alternate" type="application/atom+xml" title="takuti.me" href="https://takuti.me/index.xml" />
  </head>
  <body>
    <header class="clearfix">
      <span class="left"><a href="https://takuti.me/"><b>takuti</b>.me</a></span>
      <span class="right"><a href="https://takuti.me/about"><b>ABOUT</b></a></span>
    </header>

    <div id="container">

<article>
  <p class="meta clearfix">
    2017-08-09
  </p>
  <h2>ã‚ã®ã¨ãã®ãƒ“ãƒ¼ãƒ«ã‚’ã‚‚ã†ä¸€åº¦ï¼ˆPostgreSQLã§Fuzzy Searchã‚’è©¦ã™ï¼‰</h2>

  <div class="post">
    

<p><strong><a href="https://pragprog.com/book/rwdata/seven-databases-in-seven-weeks" target="_blank">Seven Databases in Seven Weeks</a></strong> ã‚’èª­ã‚“ã§ã„ãŸã‚‰ã€PostgreSQLã§ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã‚’ã™ã‚‹è©±ãŒå‡ºã¦ããŸã€‚<a href="https://takuti.me/note/levenshtein-distance">å…ˆæ—¥ Levenshtein Distanceï¼ˆç·¨é›†è·é›¢ï¼‰ã«ã¤ã„ã¦æ›¸ã„ãŸã°ã‹ã‚Š</a>ã§ãƒ›ãƒƒãƒˆãªè©±é¡Œãªã®ã§ã€å°‘ã—éŠã‚“ã§ã¿ã‚ˆã†ã€‚</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ postgres --version
postgres <span style="color:#333">(</span>PostgreSQL<span style="color:#333">)</span> <span style="color:#60e;font-weight:bold">9</span>.6.3</code></pre></div>
<p>â€»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨è‹±èªä»¥å¤–ã®è¨€èªã®å ´åˆã«ã¤ã„ã¦ã¯å‰²æ„›ã€‚</p>

<h3 id="ãƒ‡ãƒ¼ã‚¿">ãƒ‡ãƒ¼ã‚¿</h3>

<p>ãŠæ°—ã«å…¥ã‚Šã®<a href="https://www.kaggle.com/nickhould/craft-cans" target="_blank">ã‚¢ãƒ¡ãƒªã‚«ã®ã‚¯ãƒ©ãƒ•ãƒˆãƒ“ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ</a>ã‚’ä½¿ã†ã€‚é©å½“ã« <code>create table</code> ã—ã¦CSVã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#080;font-weight:bold">create</span> <span style="color:#080;font-weight:bold">table</span> beers (
    <span style="color:#080;font-weight:bold">key</span> <span style="color:#007020">int</span>,
    abv <span style="color:#007020">real</span>,
    ibu <span style="color:#007020">real</span>,
    id <span style="color:#007020">int</span>,
    name <span style="color:#007020">varchar</span>(<span style="color:#00d;font-weight:bold">128</span>),
    style <span style="color:#007020">varchar</span>(<span style="color:#00d;font-weight:bold">64</span>),
    brewery_id <span style="color:#007020">int</span>,
    ounces <span style="color:#007020">real</span>
);
<span style="color:#f00;background-color:#faa">\</span><span style="color:#080;font-weight:bold">copy</span> beers <span style="color:#080;font-weight:bold">from</span> <span style="background-color:#fff0f0">&#39;beers.csv&#39;</span> <span style="color:#080;font-weight:bold">with</span> csv;</code></pre></div>
<pre><code>sample=# select * from beers limit 5;
 key |  abv  | ibu |  id  |        name         |             style              | brewery_id | ounces
-----+-------+-----+------+---------------------+--------------------------------+------------+--------
   0 |  0.05 |     | 1436 | Pub Beer            | American Pale Lager            |        408 |     12
   1 | 0.066 |     | 2265 | Devil's Cup         | American Pale Ale (APA)        |        177 |     12
   2 | 0.071 |     | 2264 | Rise of the Phoenix | American IPA                   |        177 |     12
   3 |  0.09 |     | 2263 | Sinister            | American Double / Imperial IPA |        177 |     12
   4 | 0.075 |     | 2262 | Sex and Candy       | American IPA                   |        177 |     12
</code></pre>

<p>ã‚„ã£ãŸãœã€‚</p>

<p>ä»Šå›ã¯<a href="https://takuti.me/note/recsys-2016">RecSys2016ã«å‚åŠ ã—ãŸã¨ã</a>ã«ã„ã„æ„Ÿã˜ã®ãƒ‘ãƒ–ã§é£²ã‚“ã ã€<a href="http://www.notchbrewing.com/" target="_blank">Notch Brewing</a>ï¼ˆãƒã‚µãƒãƒ¥ãƒ¼ã‚»ãƒƒãƒ„å·ï¼‰ã®ãƒ“ãƒ¼ãƒ« &ldquo;<strong>Left of the Dial</strong>&rdquo; (ABV 4.3%) ã‚’å½“è©²ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰æ¢ã™ã€‚1å¹´å‰ã®æ€ã„å‡ºã‚’ã‚‚ã†ä¸€åº¦ï¼<del>ï¼ˆãã‚“ãªã«å¥½ã¿ã®ãƒ“ãƒ¼ãƒ«ã˜ã‚ƒãªã‹ã£ãŸã‘ã©ï¼‰</del></p>

<p><blockquote class="instagram-media" data-instgrm-captioned data-instgrm-version="7" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:512px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div> <p style=" margin:8px 0 0 0; padding:0 4px;"> <a href="https://www.instagram.com/p/BKji_1DDncp/" style=" color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;" target="_blank">woo~ğŸº</a></p> <p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;">A post shared by @takuti on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2016-09-19T23:09:25+00:00">Sep 19, 2016 at 4:09pm PDT</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<h3 id="å®Œå…¨ä¸€è‡´">å®Œå…¨ä¸€è‡´</h3>

<p>ã¾ãšã¯æ„šç›´ã« <code>where</code> å¥ã§å®Œå…¨ä¸€è‡´æ¤œç´¢ã‚’ã—ã¦ã¿ã‚ˆã†ï¼š</p>

<pre><code>sample=# select * from beers where name = 'Left of the Dial';
 key | abv | ibu | id | name | style | brewery_id | ounces
-----+-----+-----+----+------+-------+------------+--------
(0 rows)
</code></pre>

<p>ç„¡ã„â€¦ã€‚</p>

<h3 id="like-ã¨-ilike">LIKE ã¨ ILIKE</h3>

<p>ãã‚“ãªã¯ãšã¯ãªã„ï¼ã¨ã„ã†ã‚ã‘ã§ã€Fuzzy Search ã‚’è©¦ã¿ã‚‹ã€‚</p>

<p><code>LIKE</code> ã§ãƒ“ãƒ¼ãƒ«åã®å‰å¾Œã«ä½•ã‚‰ã‹ã®æ–‡å­—åˆ—ãŒã‚ã‚‹ã“ã¨ã‚’è¨±å®¹ã™ã‚Œã°ï¼š</p>

<pre><code>sample=# select * from beers where name LIKE '%Left of the Dial%';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p>ã‚ã£ãŸãƒ¼ï¼ABVã‚‚è¨˜éŒ²ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã€‚ã¾ã•ã«ã“ã‚Œã ã€‚</p>

<p><code>ILIKE</code> ã¯ <code>LIKE</code> ã®å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’ç„¡è¦–ã™ã‚‹ç‰ˆã§ã€å…¨éƒ¨å°æ–‡å­—ã§æ¤œç´¢ã—ã¦ã‚‚ãŠç›®å½“ã¦ã®ãƒ“ãƒ¼ãƒ«ãŒãƒ’ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«ãªã‚‹ï¼š</p>

<pre><code>sample=# select * from beers where name LIKE '%left of the dial%';
 key | abv | ibu | id | name | style | brewery_id | ounces
-----+-----+-----+----+------+-------+------------+--------
(0 rows)

sample=# select * from beers where name ILIKE '%left of the dial%';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<h3 id="æ­£è¦è¡¨ç¾">æ­£è¦è¡¨ç¾</h3>

<p>ã‚‚ã†å°‘ã—æŸ”è»Ÿã«ã€æ­£è¦è¡¨ç¾ã‚’ä½¿ã£ãŸæ¤œç´¢ã‚‚å¯èƒ½ã€‚</p>

<p>å…ˆã® <code>LIKE</code> ç›¸å½“ã®æ­£è¦è¡¨ç¾ãƒãƒƒãƒã¯ <code>~</code> ã§æ¢ã—ã¦æ¬¡ã®é€šã‚Šï¼š</p>

<pre><code>sample=# select * from beers where name ~ '.*Left of the Dial.*';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p><code>~*</code> ã§æ¢ã›ã°ã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’ç„¡è¦–ã—ã¦ãã‚Œã¦ <code>ILIKE</code> ç›¸å½“ã®çµæœã‚‚å¾—ã‚‰ã‚Œã‚‹ï¼š</p>

<pre><code>sample=# select * from beers where name ~ '.*left of the dial.*';
 key | abv | ibu | id | name | style | brewery_id | ounces
-----+-----+-----+----+------+-------+------------+--------
(0 rows)

sample=# select * from beers where name ~* '.*left of the dial.*';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<h3 id="ç·¨é›†è·é›¢">ç·¨é›†è·é›¢</h3>

<p>ã¨ã¯ã„ãˆã€æ¤œç´¢ã‚¯ã‚¨ãƒªã¯ <code>LIKE</code> ã¨æ­£è¦è¡¨ç¾ã ã‘ã§ã‚«ãƒãƒ¼ã§ãã‚‹ã»ã©å˜ç´”ãªã‚‚ã®ã§ã¯ãªã„ã€‚ç‰¹ã«typoã€ã“ã‚ŒãŒå„ä»‹ã€‚</p>

<p>ãã“ã§<strong>ç·¨é›†è·é›¢</strong> (Levenshtein Distance) ã‚’ä½¿ã£ã¦ã€ã‚‚ã†å°‘ã—typoã«ãƒ­ãƒã‚¹ãƒˆãªã‚¯ã‚¨ãƒªã«ã™ã‚‹ã€‚</p>

<p>PostgreSQLã§ã¯ <code>fuzzystrmatch</code> ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«é–¢æ•° <code>levenshtein</code> ãªã©ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼š</p>

<pre><code>sample=# create extension fuzzystrmatch;
CREATE EXTENSION
sample=# select levenshtein('kitten', 'sitting');
 levenshtein
-------------
           3
(1 row)
</code></pre>

<p>&ldquo;Left of the Dial&rdquo; ã‹ã‚‰ã®ç·¨é›†è·é›¢ãŒ10ä»¥ä¸‹ã®ãƒ“ãƒ¼ãƒ«ã¯çµæ§‹ã‚ã‚‹ï¼š</p>

<pre><code>sample=# select * from beers where levenshtein(lower(name), lower('Left of the Dial')) &lt;= 10;
 key  |  abv  | ibu |  id  |         name         |          style           | brewery_id | ounces
------+-------+-----+------+----------------------+--------------------------+------------+--------
  274 | 0.054 |     | 1411 | Sawtooth Ale         | American Blonde Ale      |        407 |     12
  383 | 0.072 |  60 | 1801 | Last Stop IPA        | American IPA             |        308 |     12
  428 | 0.073 |     | 1785 | Le Flaneur Ale       | American Wild Ale        |         10 |     16
  690 | 0.072 |     | 1623 | Lift Off IPA         | American IPA             |        358 |     16
  695 |  0.06 |     | 2371 | Neato Bandito        | Euro Pale Lager          |        127 |     12
 1101 | 0.068 |  90 | 1903 | Let It Ride IPA      | American IPA             |        277 |     12
 1385 | 0.075 |  85 | 2159 | City of the Sun      | American IPA             |        209 |     16
 1493 | 0.045 |  50 | 2692 | Get Together         | American IPA             |          0 |     16
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA             |        271 |     12
 1650 |  0.06 |  20 | 1791 | Hot Date Ale         | Chile Beer               |        314 |     16
 1658 | 0.065 |     | 2559 | Blood of the Unicorn | American Amber / Red Ale |         52 |     16
 1702 |  0.08 |     | 1375 | Nectar of the Hops   | Mead                     |        421 |     16
 2171 | 0.041 |     | 1780 | Rise to the Top      | Cream Ale                |        142 |     12
 2337 |       |     |  652 | West Sixth IPA       | American IPA             |        100 |     12
(14 rows)
</code></pre>

<p>ã¾ãŸã€<code>levenshtein_less_equal(string 1, string 2, max distance)</code> ã¯ <code>max distance</code> ã‚ˆã‚Šå°ã•ã„ç·¨é›†è·é›¢ã®æ–‡å­—åˆ—ã«å¯¾ã—ã¦ã¯ãã®æ­£ç¢ºãªç·¨é›†è·é›¢ã‚’ã€ãã‚Œä»¥å¤–ã«ã¤ã„ã¦ã¯ <code>max distance</code> ã‚ˆã‚Šå¤§ããªé©å½“ãªå€¤ï¼ˆã“ã“ã§ã¯ <code>max distance + 1</code>ï¼‰ã‚’è¿”ã™é–¢æ•°ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#080;font-weight:bold">select</span>
    name,
    levenshtein(<span style="color:#080;font-weight:bold">lower</span>(name), <span style="color:#080;font-weight:bold">lower</span>(<span style="background-color:#fff0f0">&#39;Left of the Dial&#39;</span>)), <span style="color:#888">/* æ­£ç¢ºãªç·¨é›†è·é›¢ */</span>
    levenshtein_less_equal(<span style="color:#080;font-weight:bold">lower</span>(name), <span style="color:#080;font-weight:bold">lower</span>(<span style="background-color:#fff0f0">&#39;Left of the Dial&#39;</span>), <span style="color:#00d;font-weight:bold">11</span>) <span style="color:#888">/* ç·¨é›†è·é›¢11ä»¥ä¸‹ã ã‘çœŸé¢ç›®ã«è¨ˆç®—ã™ã‚‹ */</span>
<span style="color:#080;font-weight:bold">from</span>
    beers
<span style="color:#080;font-weight:bold">limit</span>
    <span style="color:#00d;font-weight:bold">5</span>;</code></pre></div>
<pre><code>        name         | levenshtein | levenshtein_less_equal
---------------------+-------------+------------------------
 Pub Beer            |          14 |                     12
 Devil's Cup         |          14 |                     12
 Rise of the Phoenix |          11 |                     11
 Sinister            |          14 |                     12
 Sex and Candy       |          13 |                     12
(5 rows)

</code></pre>

<p>ã“ã‚Œã„ã„ã§ã™ã­ã€‚ã€<a href="https://takuti.me/note/levenshtein-distance">ã„ã¾ã•ã‚‰ç·¨é›†è·é›¢ (Levenshtein Distance) ã‚’å®Ÿè£…ã™ã‚‹ãœ</a>ã€ã§ã‚‚æ›¸ã„ãŸã¨ãŠã‚Š Levenshtein Distance ã¯å‹•çš„è¨ˆç”»æ³•ã«ã‚ˆã£ã¦è¨ˆç®—ã•ã‚Œã‚‹ã®ã§ã€æ˜ã‚‰ã‹ã« <code>max distance</code> ã‚ˆã‚Šè·é›¢ãŒå¤§ãããªã‚‹ã‚±ãƒ¼ã‚¹ã‚’ã•ã£ã•ã¨åˆ‡ã‚Šæ¨ã¦ã‚‹ã®ã¯å°ç²’ã§ã´ã‚Šã‚Šã¨è¾›ã„å·¥å¤«ã€‚</p>

<p>ç·¨é›†è·é›¢6ä»¥ä¸‹ã‚’æ¢ã›ã°ã€&rdquo;Left of the Dial IPA&rdquo; ã®ã¿ãŒãƒ’ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«ãªã‚‹ï¼š</p>

<pre><code>sample=# select * from beers where levenshtein_less_equal(lower(name), lower('Left of the Dial'), 6) &lt;= 6;
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p>ãã—ã¦å•é¡Œã®typoã ãŒã€ã“ã®é€šã‚Š <code>Dial</code> ã‚’ <code>Daniel</code> ã«typoã—ã¦ã‚‚å•é¡Œãªã„ï¼š</p>

<pre><code>sample=# select * from beers where levenshtein_less_equal(lower(name), lower('Left of the Dniel'), 6) &lt;= 6;
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p>ã€ã©ã®ç¨‹åº¦typoã‚’è¨±å®¹ã™ã‚‹ã‹ã€ã¨ã€ãƒ’ãƒƒãƒˆã™ã‚‹ä»¶æ•°ã€ã¯ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã®é–¢ä¿‚ã«ã‚ã‚‹ã®ã§ã€é–¾å€¤ã‚’å®šã‚ã‚‹ã®ã¯çµæ§‹å¤§å¤‰ã€‚</p>

<h3 id="æ–‡å­—ã®tri-gram">æ–‡å­—ã®tri-gram</h3>

<p>ç·¨é›†è·é›¢ä»¥ä¸Šã«typoã«ãƒ­ãƒã‚¹ãƒˆãªã®ãŒã€æ–‡å­—ã®<strong>tri-gram</strong>ã«ã‚ˆã‚‹æ¤œç´¢ã€‚</p>

<p>æ–‡å­—ã®tri-gramã¯<a href="https://takuti.me/note/twitter-bot">å˜èªã®ãƒãƒ«ã‚³ãƒ•é€£é–</a>ã®æ–‡å­—ç‰ˆã€ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚PostgreSQLã§ã¯ <code>pg_trgm</code> ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã„ã‚Œã‚‹ã“ã¨ã§tri-gramã®ãƒãƒƒãƒï¼ˆæ–‡å­—åˆ—ã®éƒ¨åˆ†çš„ãªä¸€è‡´ï¼‰ã«ã‚ˆã‚‹æŸ”è»Ÿãªæ¤œç´¢ãŒã§ãã‚‹ã€‚</p>

<p>ãŸã¨ãˆã° <code>Avatar</code> ã¨ã„ã†æ–‡å­—åˆ—ã‹ã‚‰ã¯ <code>av</code> ã‚„ <code>ata</code> ã®ã‚ˆã†ãªtri-gramãŒå¾—ã‚‰ã‚Œã¦ã€æˆ‘ã€…ã¯ãã®tri-gramã®æ„å‘³ã§ä¸€è‡´ã™ã‚‹æ–‡å­—åˆ—ã‚’æ¢ã™ã“ã¨ãŒã§ãã‚‹ï¼š</p>

<pre><code>sample=# create extension pg_trgm;
CREATE EXTENSION
sample=# select show_trgm('Avatar');
              show_trgm
-------------------------------------
 {&quot;  a&quot;,&quot; av&quot;,&quot;ar &quot;,ata,ava,tar,vat}
(1 row)
</code></pre>

<p>å®Ÿéš›ã«ã¯ã€<code>where</code> å¥ã® <code>=</code> ã‚„ <code>~</code> ã‚’ <code>%</code> ã«ç½®ãæ›ãˆã‚‹ã ã‘ã§tri-gramãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ãŒèµ°ã‚‹ã€‚</p>

<p>æœ«å°¾ã® <code>IPA</code> ãŒæŠœã‘è½ã¡ãŸãã‚‰ã„ã¯å•é¡Œãªã„ï¼š</p>

<pre><code>sample=# select * from beers where name % 'Left of the Dial';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p><code>Dial</code> ãŒ <code>Dia</code> ã«ãªã£ã¡ã‚ƒã£ã¦ã¦ã‚‚OKï¼š</p>

<pre><code>sample=# select * from beers where name % 'Left of the Dia';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p><code>Dial</code> ãŒå®Œå…¨ã«æŠœã‘è½ã¡ã¦ã„ã‚‹ã¨ã€tri-gramã« <code>of</code> ã‚„ <code>the</code> ã‚’å«ã‚€ä»–ã®ãƒ“ãƒ¼ãƒ«ã¾ã§ãƒ’ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«ãªã‚‹ï¼š</p>

<pre><code>sample=# select * from beers where name % 'Left of the';
 key  |  abv  | ibu |  id  |         name         |          style          | brewery_id | ounces
------+-------+-----+------+----------------------+-------------------------+------------+--------
 1047 |  0.07 |  68 | 2294 | The Power of Zeus    | American Pale Ale (APA) |        168 |     12
 1385 | 0.075 |  85 | 2159 | City of the Sun      | American IPA            |        209 |     16
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA            |        271 |     12
(3 rows)
</code></pre>

<p>å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚„ <code>Dial</code> ã®typoãã‚‰ã„ã˜ã‚ƒã¸ã“ãŸã‚Œãªã„ï¼š</p>

<pre><code>sample=# select * from beers where name % 'left of the daniel';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<h3 id="tsvector">TSVector</h3>

<p>è‡ªç„¶è¨€èªã¨ã—ã¦ã€ã‚‚ã£ã¨ç›´æ„Ÿã«å³ã—ãŸâ€œãã‚Œã£ã½ã•â€ã‚’è¦‹ãŸã‘ã‚Œã° <strong>TSVector</strong> ã¨ã„ã†è¡¨ç¾ãŒä½¿ãˆã‚‹ã€‚</p>

<p>&ldquo;Left of the Dial&rdquo; ã®TSVectorè¡¨ç¾ã¯ã“ã‚“ãªæ„Ÿã˜ï¼š</p>

<pre><code>sample=# select to_tsvector('Left of the Dial');
    to_tsvector
-------------------
 'dial':4 'left':1
(1 row)
</code></pre>

<p>ã“ã‚Œã«ã‚ˆã£ã¦èªé †ã«ä¾å­˜ã—ãªã„ã€å­—å¥ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã®å­˜åœ¨æœ‰ç„¡ã«åŸºã¥ãæ¤œç´¢ãŒå¯èƒ½ã€‚<code>of</code> ã‚„ <code>the</code> ã®ã‚ˆã†ãª stop word ã®é™¤å¤–ã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã®çµ±ä¸€ã¨ã„ã£ãŸåŸºæœ¬çš„ãªå‰å‡¦ç†ã¯å‹æ‰‹ã«ã‚„ã£ã¦ãã‚Œã‚‹ã€‚</p>

<p>ãƒ“ãƒ¼ãƒ«åã®TSVector <code>to_tsvector(name)</code> ã«ã¤ã„ã¦ã€<code>left</code> ã¨ <code>ipa</code> ã‚’å«ã‚€ã‚‚ã®ã‚’åˆ—æŒ™ã™ã‚Œã°æœŸå¾…é€šã‚Š &ldquo;Left of the Dial&rdquo; ãŒå¾—ã‚‰ã‚Œã‚‹ï¼š</p>

<pre><code>sample=# select * from beers where to_tsvector(name) @@ to_tsquery('english', 'left &amp; ipa');
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p>ãªãŠã€<code>to_tsvector() @@ to_tsquery()</code> ã¯æ¬¡ã®æ§‹æ–‡ã¨ç­‰ä¾¡ï¼š</p>

<pre><code>sample=# select * from beers where name @@ 'left &amp; ipa';
 key  |  abv  | ibu |  id  |         name         |    style     | brewery_id | ounces
------+-------+-----+------+----------------------+--------------+------------+--------
 1504 | 0.043 |     | 1917 | Left of the Dial IPA | American IPA |        271 |     12
(1 row)
</code></pre>

<p>æ®‹å¿µãªãŒã‚‰typoã¯ã‚«ãƒãƒ¼ã§ããªã„ï¼š</p>

<pre><code>sample=# select * from beers where name @@ 'left &amp; daniel';
 key | abv | ibu | id | name | style | brewery_id | ounces
-----+-----+-----+----+------+-------+------------+--------
(0 rows)
</code></pre>

<h3 id="ã‚µã‚¦ãƒ³ãƒ‰è·é›¢">ã‚µã‚¦ãƒ³ãƒ‰è·é›¢</h3>

<p>ã€Œãªã‚“ã¨ãªãè¦šãˆã¦ã„ã‚‹ã‘ã©ã€æ­£ç¢ºã«ã¯æ›¸ã‘ãªã„ï¼ã€ã¨ã„ã†ã¨ãã®ãŸã‚ã«ã€ã‚·ã‚¹ãƒ†ãƒ ã¯typoã«ãƒ­ãƒã‚¹ãƒˆã§ã‚ã£ã¦ã»ã—ã„ã€‚ã“ã“ã¾ã§è¦‹ã¦ããŸã®ã¯ã€ãã®ãŸã‚ã®ã‚¹ãƒšãƒ«ã«åŸºã¥ãæ§˜ã€…ãªFuzzy Searchæ‰‹æ³•ã€‚</p>

<p>ä¸€æ–¹ã€ã‚¹ãƒšãƒ«ã§ã¯ãªãâ€œç™ºéŸ³ã®è¿‘ã•â€ï¼ˆ<strong>ã‚µã‚¦ãƒ³ãƒ‰è·é›¢</strong>ï¼‰ã§æ¤œç´¢ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ã€‚</p>

<p>ã“ã®æ©Ÿèƒ½ã¯ <code>levenshtein</code> ã®ã¨ãã«ã„ã‚ŒãŸ <code>fuzzystrmatch</code> ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å«ã¾ã‚Œã¦ã„ã‚‹ã€‚</p>

<p><code>IPA</code>ï¼ˆã‚ã„ã´ãƒ¼ãˆãƒ¼ï¼‰ã‚’ <code>ipear</code>ï¼ˆã‚ã„ãºã‚ãƒ¼ï¼‰ã¨èª­ã‚“ã§ã¿ã‚ˆã†ã€‚ <code>ipear</code> ã®ç™ºéŸ³ã¯æ¬¡ã®ã‚ˆã†ã«è¨˜å·åŒ–ã•ã‚Œã‚‹ï¼š</p>

<pre><code>sample=# select dmetaphone('ipear'), dmetaphone_alt('ipear'), metaphone('ipear', 8), soundex('ipear');
 dmetaphone | dmetaphone_alt | metaphone | soundex
------------+----------------+-----------+---------
 APR        | APR            | IPR       | I160
(1 row)
</code></pre>

<p>æ˜ã‚‰ã‹ã«typoã®åŸŸã‚’è¶Šãˆã¦ã„ã‚‹ã®ã§ã€ç´ ã®tri-gramã§ã¯ä½•ã‚‚ãƒ’ãƒƒãƒˆã—ãªã„ï¼š</p>

<pre><code>sample=# select * from beers where name % 'ipear';
 key | abv | ibu | id | name | style | brewery_id | ounces
-----+-----+-----+----+------+-------+------------+--------
(0 rows)
</code></pre>

<p>ã—ã‹ã—ï¼ˆè¨˜å·åŒ–ã•ã‚ŒãŸï¼‰<strong>ç™ºéŸ³ã®tri-gram</strong>ã‚’æ¯”è¼ƒã™ã‚Œã°ï¼š</p>

<pre><code>sample=# select * from beers where metaphone(name, 8) % metaphone('ipear', 8);
 key  |  abv  | ibu |  id  |   name   |    style     | brewery_id | ounces
------+-------+-----+------+----------+--------------+------------+--------
   97 | 0.065 |     | 2578 | IPA      | American IPA |         35 |     12
  591 | 0.057 |  58 | 2380 | IPA #11  | American IPA |        121 |     16
  892 | 0.074 |  74 | 1777 | 2020 IPA | American IPA |        240 |     16
 1114 | 0.068 |  55 |  558 | I-10 IPA | American IPA |        527 |     12
 1192 | 0.068 |     | 2493 | I.P. Eh! | American IPA |         59 |     12
 1906 |  0.07 | 113 |   24 | 113 IPA  | American IPA |        371 |     12
(6 rows)

</code></pre>

<p>ãŠã‰ãƒ¼IPAã‚ã£ã¡ã‚ƒå‡ºã¦ãã‚‹ãƒ¼ã€‚</p>

<h3 id="ã¾ã¨ã‚">ã¾ã¨ã‚</h3>

<p>ä»¥ä¸Šã€æŸ”è»Ÿãªæ¤œç´¢ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®Fuzzy Searchæ‰‹æ³•ãŸã¡ã§ã—ãŸã€‚</p>

<p>å®Ÿéš›ã®ã¨ã“ã‚ã€RDBä¸Šã§ã®Fuzzy Searchã£ã¦ä¸–ã®ä¸­ã§ã¯ã©ã‚Œã ã‘å®Ÿç”¨ã•ã‚Œã¦ã„ã‚‹ã‚“ã ã‚ã†ã‹ã€‚ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®è¨ˆç®—é‡ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã©ã‚Œã ã‘åŠ¹æœçš„ã«ä½¿ãˆã‚‹ã‹ã€æœŸå¾…ã™ã‚‹å‡ºåŠ›ã€etc..ã«å¿œã˜ã¦é©åˆ‡ãªæ¤œç´¢æ‰‹æ³•ã‚’é¸æŠã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãªã‹ãªã‹é›£ã—ã„è©±é¡Œã ã¨æ€ã†ã€‚</p>

<p>ãã—ã¦è¤‡æ•°ã®æ‰‹æ³•ã‚’çµ„ã¿åˆã‚ã›ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰Fuzzy Searchã‚‚å¯èƒ½ãªã®ã§ã€ã•ã‚‰ã«æ‚©ã‚€ã€‚&rdquo;Seven Databases in Seven Weeks&rdquo; ã§ã¯æ¬¡ã®ã‚ˆã†ãªã‚¯ã‚¨ãƒªãŒç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#080;font-weight:bold">select</span> <span style="color:#333">*</span> <span style="color:#080;font-weight:bold">from</span> actors
<span style="color:#080;font-weight:bold">where</span> metaphone(name,<span style="color:#00d;font-weight:bold">8</span>) <span style="color:#333">%</span> metaphone(<span style="background-color:#fff0f0">&#39;Robin Williams&#39;</span>,<span style="color:#00d;font-weight:bold">8</span>)
<span style="color:#080;font-weight:bold">order</span> <span style="color:#080;font-weight:bold">by</span> levenshtein(<span style="color:#080;font-weight:bold">lower</span>(<span style="background-color:#fff0f0">&#39;Robin Williams&#39;</span>), <span style="color:#080;font-weight:bold">lower</span>(name));</code></pre></div>
<p>ï¼ˆLevenshtein Distance ã§ <code>order by</code> ã¨ã‹çµ¶å¯¾ã‚„ã‚ŠãŸããªã„ã‘ã©â€¦ã€‚ï¼‰</p>

<p>ã¾ãç´°ã‹ã„ã“ã¨ã¯æ°—ã«ã›ãšã€ã¿ã‚“ãªã‚‚æ€ã„å‡ºã®ãƒ“ãƒ¼ãƒ«ã‚’æ¤œç´¢ã—ã¦ã¿ã‚ˆã†ï¼ï¼ˆï¼Ÿï¼‰</p>

<ul>
<li><a href="https://www.postgresql.org/docs/9.6/static/fuzzystrmatch.html" target="_blank">fuzzystrmatch</a></li>
<li><a href="https://www.postgresql.org/docs/9.6/static/pgtrgm.html" target="_blank">pg_trgm</a></li>
</ul>

    <br /><a href="https://twitter.com/share" class="twitter-share-button" data-via="takuti">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </div>

</article>
<aside class="clearfix">
  <span class="left" style="width: 10%">
    <img src="https://takuti.me/images/takuti.jpg" alt="takuti" class="icon-circle" />
  </span>
  <span class="right" style="width: 90%">
    I am <b>Takuya Kitazawa</b> (a.k.a. <b>takuti</b>), a data science engineer at <b><a href="https://www.treasuredata.com/" class="post-style" target="_blank" rel="noopener">Treasure Data, Inc.</a></b> and <b><a href="https://hivemall.incubator.apache.org/" class="post-style" target="_blank" rel="noopener">Apache Hivemall</a></b> Committer<span class="symbol">twinkle</span><a href="https://takuti.me/about">&raquo; more</a>
  </span>
</aside>

    </div>

    <footer>
      &copy; 2012-2016 Takuya Kitazawa.
    </footer>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
    <script>
      renderMathInElement(document.body,
        {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
            ]
        }
      );

      var inlineMathArray = document.querySelectorAll("script[type='math/tex']");
      for (var i = 0; i < inlineMathArray.length; i++) {
        var inlineMath = inlineMathArray[i];
        var tex = inlineMath.innerText || inlineMath.textContent;
        var replaced = document.createElement("span");
        replaced.innerHTML = katex.renderToString(tex, {displayMode: false});
        inlineMath.parentNode.replaceChild(replaced, inlineMath);
      }

      var displayMathArray = document.querySelectorAll("script[type='math/tex; mode=display']");
      for (var i = 0; i < displayMathArray.length; i++) {
        var displayMath = displayMathArray[i];
        var tex = displayMath.innerHTML;
        var replaced = document.createElement("span");
        replaced.innerHTML = katex.renderToString(tex.replace(/%.*/g, ''), {displayMode: true});
        displayMath.parentNode.replaceChild(replaced, displayMath);
      }
    </script>
    

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-28919399-2', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

